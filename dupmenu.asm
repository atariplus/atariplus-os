10 ;THOR - DUP VERSION 1.12 VOM 29.1.1990
20       .OPT OBJ
30       *=  $0800
40 DL1   .DS $40
50 MENBI .DS $03C0
60 DL2   .DS $40
70 INPBF .DS 80
80 BUF1  .DS 40
90 BUF2  .DS 40
100 BUF3 .DS 40
110 HDL  .DS 40
120 JMPTAB .DS 27*2
130 JUMPTAB ;        AB HIER SYSTEMPARAMETER & EINSPRUNGADRESSEN
140 DUPEND .WORD 0
150 STAX .BYTE 0
160 EXT  .BYTE 0
170 NEW  .BYTE 0
180 SWT  .BYTE 0
190 DLW  .BYTE 0
200 MAX  .BYTE 0
210 DEFLEN .BYTE 3
220 DEFAULT .BYTE "D1:"
230      JMP START
240      JMP INIT
250      JMP PRINT   ;(X,Y,A)
260      JMP SETIOCB ;X
270      JMP SETINPBF ;->X,Y
280      JMP SETBUF1 ; "
290      JMP SETBUF2 ; "
300      JMP SETBUF3 ; "
310      JMP OPEN    ;(X,Y),A=AUX1
320      JMP CLOSE   ;
330      JMP XIO     ;(X,Y),A=COM
340      JMP CLRAUX  ;0->AUX1,2
350      JMP INPUT   ;(X,Y),A
360      JMP ERROR   ;Y
370      JMP TOHDL   ;(X,Y),A
380      JMP INHDL   ;
390      JMP RESERVE ;(X,Y)
400      JMP DISPOSE ;(X,Y)
410      JMP SETOLD  ;
420      JMP SUBERROR ;Y
430      JMP SUBERROR2 ;Y
440      JMP BLOCK   ;
450      JMP GETNEXT ;->(X,Y) AUS INPBF,Z=1 LEER,C=1 ENDE DER ZEILE
460      JMP COPY    ;(X,Y),A->D4,D5
470      JMP PARAM   ;
480      JMP NORM
490      JMP RED
500      JMP GREEN
510      JMP BLUE
520      JMP YELLOW
530      JMP EXBLOCK
540      JMP BBREAK
550      JMP EBREAK
560      JMP TODEC   ;X,Y->BUF3
570      JMP TOHEX   ;X,Y->BUF3
580      JMP FRDEC   ;(X,Y)->X,Y
590      JMP FRHEX   ; "
600      JMP SETAUX  ;X->AUX1,Y->AUX2
610      JMP SETBUF  ;X,Y
620      JMP SETLEN  ;X,Y
630      JMP SETCOM  ;A
640      JMP TOCIO   ;A
650      JMP GKEY    ;->A(Y)
660      JMP BGET    ;(X,Y),LEN PRE
670      JMP BPUT    ;  "
680      JMP PRIND   ;(X,Y),A
690      JMP ADDD    (X,Y)
700      JMP CONFILE (X,Y)->BUF3
710      JMP GETEXT  ; SUCHE AB (X,Y) /A WENN GEF. SO DELETE,C=1
720      JMP MOVE    ;X->Y (X,Y=REGNR.)
730      JMP CURSOFF
740      JMP CURSON
750      JMP PRINTEOL
760      JMP TOZERO
770      JMP TOCAR
780      JMP TODOS
790      JMP YESNO
800      JMP CLOSEALL
810      JMP GETLIST ; (X,Y)->(X,Y) DURCH #1
820      JMP GETENTRY ; A=DEV#,(X,Y)->INPBF, C=1 ENDE (X,Y)=POINTER AUF CPT.
830      JMP GETDEVNO ; (X,Y)->A = DEVICE #
840      JMP SETDEFAUL
850      JMP GETLEN
860      JMP DLOLD
870      JMP DLNEW
880 IOCB =   $B0
890 MEMHI =  $0E
900      ;   
910      ;           ENDE JMPTAB
920 TITLE .SBYTE "‘»œ“≠ƒı††÷ÂÚÛÈÔÓ†±Æ±†®„©†±ππ∞†‘»œ“†ÈÓ„Æ"
930 PRINT ;          X,Y,A
940      STA $0348
950      STX $0344
960      STY $0345
970      LDX #$00
980      TXA 
990      STA $0349,X
1000     LDA #$0B
1010     STA $0342,X
1020     JSR $E456
1030     BMI TMAN
1040     RTS 
1050 MV  .BYTE ""
1060 CURSON LDA #$00
1070     BEQ OV
1080 CURSOFF LDA #$01
1090 OV  STA 752
1100     LDX # <MV
1110     LDY # >MV
1120     LDA #2
1130     JSR PRINT
1140     RTS 
1150 TMAN JMP MAIN
1160 PRINTEOL
1170     LDX # <EOL
1180     LDY # >EOL
1190     LDA #1
1200     JSR PRINT
1210     RTS 
1220 EOL .BYTE 155
1230 PRIND STA $0348
1240     STX $0344
1250     STY $0345
1260     LDX #$00
1270     TXA 
1280     STA $0349,X
1290     LDA #$09
1300     STA $0342,X
1310     JSR $E456
1320 TMAN1 BMI TMAN
1330     RTS 
1340 SETIOCB STX IOCB
1350     RTS 
1360 SETINPBF
1370     LDX # <INPBF
1380     LDY # >INPBF
1390     LDA #80
1400     RTS 
1410 SETBUF1
1420     LDX # <BUF1
1430     LDY # >BUF1
1440     LDA #40
1450     RTS 
1460 SETBUF2
1470     LDX # <BUF2
1480     LDY # >BUF2
1490     LDA #40
1500     RTS 
1510 SETBUF3
1520     LDX # <BUF3
1530     LDY # >BUF3
1540     LDA #40
1550     RTS 
1560 GETLEN LDX IOCB
1570     LDA $0349,X
1580     TAY 
1590     LDA $0348,X
1600     TAX 
1610     RTS 
1620 OPEN PHA 
1630     JSR SETBUF
1640     PLA 
1650     STA $034A,X
1660     LDA #$03
1670     STA $0342,X
1680     LDA #$00
1690     STA $034B,X
1700     JSR $E456
1710     RTS 
1720 CLOSE LDA #$0C
1730     LDX IOCB
1740     STA $0342,X
1750     JSR $E456
1760     RTS 
1770 XIO
1780     PHA 
1790     JSR SETBUF
1800     PLA 
1810     STA $0342,X
1820     JSR $E456
1830     RTS 
1840 BGET JSR SETBUF
1850     LDA #$07
1860     STA $0342,X
1870     JSR $E456
1880     RTS 
1890 BPUT JSR SETBUF
1900     LDA #$0B
1910     STA $0342,X
1920     JSR $E456
1930     RTS 
1940 CLRAUX LDX IOCB
1950     LDA #$00
1960     STA $034A,X
1970     STA $034B,X
1980     RTS 
1990 SETAUX TXA 
2000     LDX IOCB
2010     STA $034A,X
2020     TYA 
2030     STA $034B,X
2040     RTS 
2050 SETBUF TXA 
2060     LDX IOCB
2070     STA $0344,X
2080     TYA 
2090     STA $0345,X
2100     RTS 
2110 SETLEN TXA 
2120     LDX IOCB
2130     STA $0348,X
2140     TYA 
2150     STA $0349,X
2160     RTS 
2170 SETCOM LDX IOCB
2180     STA $0342,X
2190     RTS 
2200 TOCIO
2210     JSR SETCOM
2220     JSR $E456
2230     RTS 
2240 KEYO .BYTE "K:",155
2250 KEYOPEN LDX #$70
2260     JSR SETIOCB
2270     JSR CLOSE
2280     LDX # <KEYO
2290     LDY # >KEYO
2300     LDA #4
2310     JSR OPEN
2320     LDX #$00
2330     LDY #$00
2340     JSR SETLEN
2350     LDA #$07
2360     JSR SETCOM
2370     RTS 
2380 GKEY LDX #$70
2390     JSR $E456
2400     BMI TMAN2
2410     RTS 
2420 TMAN2 JMP MAIN
2430 INPUT STA $0348
2440     STX $0344
2450     STY $0345
2460     LDA #$00
2470     TAX 
2480     STA $0349
2490     LDA #$05
2500     STA $0342,X
2510     JSR $E456
2520     BMI TMAN2
2530     RTS 
2540 YESNO JSR GKEY
2550     AND #$5F
2560     CMP #'Y
2570     BEQ YS
2580     CMP #'J
2590     BEQ YS
2600     CLC 
2610     RTS 
2620 YS  SEC 
2630     RTS 
2640 TOCAR LDA #$F0
2650     STA NEW
2660     JMP $E474
2670 TODOS LDA #$F0
2680     STA NEW
2690     LDA #$80
2700     STA EXT
2710     JMP $E474
2720 TOHDL JSR TOZERO
2730     TAY 
2740     BEQ EHDL
2750     DEY 
2760 THC LDA ($B2),Y
2770     ORA #$80
2780     STA HDL,Y
2790     DEY 
2800     BPL THC
2810 EHDL RTS 
2820 TOZERO STX $B2
2830     STY $B3
2840     RTS 
2850 INHDL LDY #$27
2860     LDA #$80
2870 IHDL STA HDL,Y
2880     DEY 
2890     BPL IHDL
2900     RTS 
2910 RESERVE LDA MEMHI+1
2920     PHA 
2930     LDA MEMHI
2940     PHA 
2950     CLC 
2960     TXA 
2970     ADC MEMHI
2980     STA MEMHI
2990     TYA 
3000     ADC MEMHI+1
3010     STA MEMHI+1
3020     LDA MEMHI
3030     CMP $02E5
3040     LDA MEMHI+1
3050     SBC $02E6
3060     BCS MEMER
3070     PLA 
3080     TAX 
3090     PLA 
3100     TAY 
3110     RTS 
3120 MEMER JSR INHDL
3130     LDX # <MEMT
3140     LDY # >MEMT
3150     LDA #MEMTL
3160     JSR TOHDL
3170     JMP SYSIN
3180 MEMT .SBYTE "Out of memory,Q to Quit,R to retry"
3190 MEMTL = *-MEMT
3200 DISPOSE
3210     STX MEMHI
3220     STY MEMHI+1
3230     RTS 
3240 SETOLD
3250     LDX DUPEND
3260     LDY DUPEND+1
3270     JSR DISPOSE
3280     RTS 
3290 SUBERROR
3300     CPY #$00
3310     CLC 
3320     BPL NONER
3330     CPY #136
3340     SEC 
3350     BEQ NONER
3360     JMP ERROR
3370 NONER RTS 
3380 BLOCK
3390     LDA #$FF
3400     STA SWT
3410     RTS 
3420 EXBLOCK
3430     LDA #$00
3440     STA SWT
3450     RTS 
3460 BBREAK
3470     LDA $10
3480     AND #$7F
3490     STA $10
3500     STA $D20E
3510     RTS 
3520 EBREAK
3530     LDA $10
3540     ORA #$80
3550     STA $10
3560     STA $D20E
3570     LDA #$80
3580     STA $11
3590     RTS 
3600 NORM
3610     LDA #$90
3620     BNE COLOR
3630 RED
3640     LDA #$30
3650     BNE COLOR
3660 GREEN
3670     LDA #$B0
3680     BNE COLOR
3690 BLUE
3700     LDA #$80
3710     BNE COLOR
3720 YELLOW
3730     LDA #$10
3740 COLOR
3750     STA 710
3760     ORA #$02
3770     STA 712
3780     AND #$F0
3790     ORA #$0C
3800     STA 709
3810     LDA $14
3820 CLW CMP $14
3830     BEQ CLW
3840     RTS 
3850 PRMER .SBYTE "Parameter Error !"
3860 PARAM JSR INHDL
3870     LDX # <PRMER
3880     LDY # >PRMER
3890     LDA #17
3900     JSR TOHDL
3910     JMP ERRCNT
3920 ERHDL .SBYTE "Error - xxx !"
3930 ERROR TYA 
3940     PHA 
3950     JSR INHDL
3960     LDY #$00
3970     PLA 
3980     PHA 
3990     TAX 
4000     JSR TODEC
4010     LDX #$02
4020 EC  LDA BUF3,X
4030     AND #$1F
4040     STA ERHDL+8,X
4050     DEX 
4060     BPL EC
4070     LDX # <ERHDL
4080     LDY # >ERHDL
4090     LDA #12
4100     JSR TOHDL
4110     PLA 
4120     LDX #$00
4130 ESL LDY ERTAB,X
4140     BEQ EN
4150     CMP ERTAB,X
4160     BEQ FND
4170     PHA 
4180     TXA 
4190     CLC 
4200     ADC #$10
4210     TAX 
4220     PLA 
4230     CPX #$00
4240     BNE ESL
4250     BEQ EN
4260 FND LDY #$00
4270 FNL LDA ERTAB+1,X
4280     ORA #$80
4290     STA HDL+20,Y
4300     INX 
4310     INY 
4320     CPY #$0F
4330     BNE FNL
4340 EN
4350 ERRCNT
4360     JSR YELLOW
4370     JSR CLOSEALL
4380     JSR SETOLD
4390     JSR SOUND
4400     BIT EXT
4410     BMI TMS
4420     JSR GKEY
4430 TMS JMP MAIN
4440 TODEC
4450     STX $D4
4460     STY $D5
4470     JSR $D9AA   ; INT->FR0
4480     JSR $D8E6   ; FR0->ASCII
4490     CLD 
4500     LDY #$00
4510 TOLP LDA ($F3),Y
4520     PHP 
4530     AND #$7F
4540     STA BUF3,Y
4550     INY 
4560     PLP 
4570     BPL TOLP
4580     LDA #$20
4590 TD  STA BUF3,Y
4600     INY 
4610     CPY #40
4620     BCC TD
4630     RTS 
4640 TOHEX
4650     JSR TOZERO
4660     LDA #$20
4670     LDX #39
4680 SX  STA BUF3,X
4690     DEX 
4700     BPL SX
4710     LDA $B3
4720     JSR CONDIG
4730     STX BUF3
4740     STY BUF3+1
4750     LDA $B2
4760     JSR CONDIG
4770     STX BUF3+2
4780     STY BUF3+3
4790     CLD 
4800     RTS 
4810 CONDIG PHA 
4820     LSR A
4830     LSR A
4840     LSR A
4850     LSR A
4860     JSR THX
4870     TAX 
4880     PLA 
4890     AND #$0F
4900     JSR THX
4910     TAY 
4920     RTS 
4930 THX
4940     SED 
4950     CLC 
4960     ADC #$90
4970     ADC #$40
4980     CLD 
4990     RTS 
5000 FRDEC
5010     STX $F3
5020     STY $F4
5030     LDA #$00
5040     STA $F2
5050     JSR $D800   ;ASCII->FR0
5060     BCS PRJM
5070     JSR $D9D2   ;FR0->INT
5080     BCS PRJM
5090     LDX $D4
5100     LDY $D5
5110     RTS 
5120 PRJM JMP PARAM
5130 FRHEX
5140     STX $D6
5150     STY $D7
5160     LDY #$00
5170     STY $D4
5180     STY $D5
5190 CL
5200     LDA ($D6),Y
5210     JSR DGCON
5220     BCS ABORT
5230     PHA 
5240     JSR SHIFT
5250     PLA 
5260     ORA $D4
5270     STA $D4
5280     INY 
5290     CPY #$05
5300     BCC CL
5310     BCS PRJM
5320 ABORT CPY #$00
5330     BEQ PRJM
5340     LDA ($D6),Y
5350     CMP #$9B
5360     BEQ COAB
5370     CMP #',
5380     BNE PRJM
5390 COAB LDX $D4
5400     LDY $D5
5410     RTS 
5420 SHIFT
5430     ASL $D4
5440     ROL $D5
5450     ASL $D4
5460     ROL $D5
5470     ASL $D4
5480     ROL $D5
5490     ASL $D4
5500     ROL $D5
5510     RTS 
5520 DGCON SEC 
5530     SBC #'0
5540     BCC ERO
5550     CMP #10
5560     BCC OKCN
5570     SBC #7
5580     CMP #10
5590     BCC ERO
5600     CMP #16
5610     BCS ERO
5620 OKCN CLC 
5630     RTS 
5640 ERO SEC 
5650     RTS 
5660 GETNEXT
5670     JSR TOZERO
5680     LDY #$00
5690     LDX #$00
5700 GTLP LDA INPBF,X
5710     CMP #$9B
5720     BEQ ENMV
5730     CMP #',
5740     BEQ ENMV
5750     STA ($B2),Y
5760     INY 
5770     INX 
5780     CPY #39
5790     BCC GTLP
5800     JMP PARAM
5810 ENMV CLC 
5820     PHP 
5830     CMP #$9B
5840     BNE JB
5850     PLP 
5860     SEC 
5870     PHP 
5880     STA INPBF+1,X
5890 JB  LDA #$9B
5900     STA ($B2),Y
5910     INX 
5920     LDY #$00
5930 SHB LDA INPBF,X
5940     STA INPBF,Y
5950     INY 
5960     INX 
5970     CPX #80
5980     BCC SHB
5990     LDY #$00
6000     LDA ($B2),Y
6010     PLP 
6020     EOR #$9B
6030     RTS 
6040 COPY JSR TOZERO
6050     TAY 
6060     BEQ EXT2
6070     DEY 
6080 CLC
6090     LDA ($B2),Y
6100     STA ($D4),Y
6110     DEY 
6120     BPL CLC
6130 EXT2 RTS 
6140 SOUND
6150     LDA #$03
6160     STA $D20F
6170     LDA #$00
6180     STA $D208
6190     LDA #$CF
6200     STA $D201
6210     STA $D203
6220     LDA #12
6230     STA $D200
6240     LDA #15
6250     STA $D202
6260     LDX #20
6270 WT2 LDA $14
6280 WT  CMP $14
6290     BEQ WT
6300     DEX 
6310     BPL WT2
6320     LDA #$00
6330     STA $D201
6340     STA $D203
6350     RTS 
6360 ERTAB .BYTE $80,"break abort    "
6370     .BYTE $B3,"cant load     "
6380     .BYTE 138,"device timout  "
6390     .BYTE 139,"device nak     "
6400     .BYTE 140,"serial bus     "
6410     .BYTE 143,"checksum       "
6420     .BYTE 144,"device done    "
6430     .BYTE 145,"verify         "
6440     .BYTE 160,"device  error "
6450     .BYTE 162,"disk full      "
6460     .BYTE 163,"protected      "
6470     .BYTE 164,"file mismatch  "
6480     .BYTE 165,"file name error"
6490     .BYTE 167,"file locked    "
6500     .BYTE 169,"directory full "
6510     .BYTE 170,"file not found "
6520     .BYTE 0
6530 ADDD JSR TOZERO
6540     LDY #$00
6550     LDA ($B2),Y
6560     CMP #$9B
6570     BEQ DB
6580     INY 
6590     LDA ($B2),Y
6600     CMP #':
6610     BEQ DA
6620     CMP #$9B
6630     BEQ DB
6640     INY 
6650     LDA ($B2),Y
6660     CMP #':
6670     BEQ DA
6680 DB  LDA $B2
6690     CLC 
6700     ADC DEFLEN
6710     STA $B4
6720     LDA $B3
6730     ADC #$00
6740     STA $B5
6750     LDA #39
6760     SEC 
6770     SBC DEFLEN
6780     TAY 
6790 ADL1 LDA ($B2),Y
6800     STA ($B4),Y
6810     DEY 
6820     BPL ADL1
6830     LDY DEFLEN
6840     BEQ DA1
6850     DEY 
6860 ADL2 LDA DEFAULT,Y
6870     STA ($B2),Y
6880     DEY 
6890     BPL ADL2
6900 DA1 SEC 
6910     RTS 
6920 DA  CLC 
6930     RTS 
6940 SUBERROR2 CPY #$00
6950     BPL NER2
6960     CPY #$80
6970     BEQ BRAB2
6980     CPY #$00
6990     SEC 
7000     RTS 
7010 NER2 CLC 
7020     RTS 
7030 BRAB2 LDX STAX
7040     TXS 
7050     JMP MAIN
7060 CONFILE
7070     JSR TOZERO
7080     LDY #$02
7090     LDX #$00
7100 CN1 LDA ($B2),Y
7110     CMP #$20
7120     BEQ ABR1
7130     STA BUF3,X
7140     INY 
7150     INX 
7160     CPY #$0A
7170     BCC CN1
7180 ABR1 LDA #'.
7190     STA BUF3,X
7200     INX 
7210     LDY #$0A
7220 CN2 LDA ($B2),Y
7230     CMP #$20
7240     BEQ EXC
7250     STA BUF3,X
7260     INX 
7270     INY 
7280     CPY #$0D
7290     BNE CN2
7300 EXC LDA #$9B
7310     STA BUF3,X
7320     JSR SETBUF3
7330     RTS 
7340 GETEXT
7350     JSR TOZERO
7360     STA $B6
7370     LDY #$00
7380 GT2 LDA ($B2),Y
7390     CMP #$9B
7400     BEQ FNT
7410     CMP #'/
7420     BEQ FNT2
7430     INY 
7440     BNE GT2
7450 FNT2 INY 
7460     LDA ($B2),Y
7470     CMP $B6
7480     BNE GT2
7490     DEY 
7500     LDA #$9B
7510     STA ($B2),Y
7520     SEC 
7530     RTS 
7540 FNT CLC 
7550     RTS 
7560 MOVE TYA 
7570     ASL A
7580     TAY 
7590     LDA BADR,Y
7600     STA $D4
7610     LDA BADR+1,Y
7620     STA $D5
7630     TXA 
7640     ASL A
7650     TAX 
7660     LDA BADR+1,X
7670     TAY 
7680     LDA BADR,X
7690     TAX 
7700     LDA #40
7710     JSR COPY
7720     RTS 
7730 BADR .WORD INPBF,BUF1,BUF2,BUF3
7740 VBI LDA #$08
7750     STA $D01F
7760     LDA SWT
7770     BMI DLI2
7780     LDA DLW
7790     BMI WTOF
7800     LDA $D01F
7810     CMP #$05
7820     BNE NINV
7830     LDA DLW
7840     EOR #$81
7850     STA DLW
7860 NINV LDA DLW
7870     LSR A
7880     LDY # <DL1
7890     LDX # >DL1
7900     BCS D2
7910 DLI2 LDY # <DL2
7920     LDX # >DL2
7930 D2  STX 561
7940     STY 560
7950     STX $D403
7960     STY $D402
7970 D3  JMP $E45F
7980 WTOF
7990     LDA $D01F
8000     CMP #$07
8010     BNE D3
8020     LDA DLW
8030     AND #$7F
8040     STA DLW
8050     BPL D3
8060 VBIINIT
8070     LDA #$00
8080     STA SWT
8090     LDA #$01
8100     STA DLW
8110 VBI2 LDA #$06
8120     LDX # >VBI
8130     LDY # <VBI
8140     JSR $E45C
8150     RTS 
8160 DLNEW LDA 87
8170     BEQ DLN
8180     JSR GRAPH0
8190 DLN JSR VBI2
8200     LDA #0
8210     STA 82
8220     STA 85
8230     STA 86
8240     LDA #39
8250     STA 83
8260     LDA #23
8270     STA 84
8280     RTS 
8290 GRTO LDA $E401
8300     PHA 
8310     LDA $E400
8320     PHA 
8330     RTS 
8340 GRAPH0 JSR GRTO
8350     LDA 560
8360     STA DLLD
8370     LDA 561
8380     STA DLLD+1
8390     RTS 
8400 DLOLD LDA #$06
8410     LDX # >$E45F
8420     LDY # <$E45F
8430     JSR $E45C
8440     LDA DLLD
8450     STA $0230
8460     LDA DLLD+1
8470     STA $0231
8480     LDA #2
8490     STA 82
8500     STA 85
8510     LDA #0
8520     STA 86
8530     JSR CURSON
8540     RTS 
8550 DLLD .WORD 0
8560 DLWAUF ;        DL AB (B2,B3) AUFBAUEN,X REIHEN MENU
8570     STX $B4
8580     LDA $B3
8590     PHA 
8600     LDA $B2
8610     PHA 
8620     LDA #$70
8630     JSR PUT
8640     LDA #$42
8650     JSR PUT
8660     LDA # <TITLE
8670     JSR PUT
8680     LDA # >TITLE
8690     JSR PUT
8700     LDA 88
8710     STA $B6
8720     LDA 89
8730     STA $B7
8740     LDA #24
8750     STA $B5
8760     LDX $B4
8770     BEQ NOMEN
8780     LDA #$42
8790     JSR PUT
8800     LDA # <MENBI
8810     JSR PUT
8820     LDA # >MENBI
8830     JSR PUT
8840     JSR INC
8850     DEC $B4
8860     BEQ NOMEN
8870 DA2 LDA #$02
8880     JSR PUT
8890     JSR INC
8900     DEC $B4
8910     BNE DA2
8920 NOMEN LDA #$42
8930     JSR PUT
8940     LDA # <HDL
8950     JSR PUT
8960     LDA # >HDL
8970     JSR PUT
8980     LDA #$42
8990     JSR PUT
9000     LDA $B6
9010     JSR PUT
9020     LDA $B7
9030     JSR PUT
9040     DEC $B5
9050     BEQ EAUF
9060 DA3 LDA #$02
9070     JSR PUT
9080     DEC $B5
9090     BNE DA3
9100 EAUF LDA #$41
9110     JSR PUT
9120     PLA 
9130     JSR PUT
9140     PLA 
9150     JSR PUT
9160     RTS 
9170 PUT LDY #$00
9180     STA ($B2),Y
9190     INC $B2
9200     BNE PT1
9210     INC $B3
9220 PT1 RTS 
9230 INC LDA $B6
9240     CLC 
9250     ADC #40
9260     STA $B6
9270     BCC IN2
9280     INC $B7
9290 IN2 DEC $B5
9300     RTS 
9310 DLINIT
9320     JSR CLRBI
9330     LDX # <DL1
9340     LDY # >DL1
9350     JSR TOZERO
9360     LDX #$00
9370     JSR DLWAUF
9380     LDX # <DL2
9390     LDY # >DL2
9400     JSR TOZERO
9410     LDX #$00
9420     JSR DLWAUF
9430     JSR INHDL
9440     JSR VBIINIT
9450     RTS 
9460 CLRBI LDX # <DL1
9470     LDY # >DL1
9480     JSR TOZERO
9490     LDX #$04
9500     LDY #$00
9510     TYA 
9520 C1  STA ($B2),Y
9530     INY 
9540     BNE C1
9550     INC $B3
9560     DEX 
9570     BNE C1
9580     RTS 
9590 ;
9600 RESET
9610 INI JSR $FFFF
9620     LDA #$03
9630     STA $02F1
9640     LDA #$FF
9650     STA $02FC
9660     LDA OLDE
9670     STA MEMHI
9680     LDA OLDE+1
9690     STA MEMHI+1
9700     LDA # <INI
9710     STA $0C
9720     LDA # >INI
9730     STA $0D
9740     LDA NEW
9750     CMP #$F0
9760     BEQ TOCR
9770     CMP #$EF
9780     BEQ TOCR2
9790     LDA #$00
9800     STA EXT
9810     JMP INIT
9820 TOCR LDA OLDGINT
9830     BEQ NOMODL
9840     LDX #$00
9850     JSR SWITCH
9860 NOMODL LDA OLDBAS
9870     STA $03F8
9880     LDA OLDEB
9890     STA $03EB
9900     DEC NEW
9910     JMP $E474
9920 TOCR2 LDA #$00
9930     STA 8
9940     TAX 
9950 TCR2 STA $80,X
9960     INX 
9970     BPL TCR2
9980     LDA INI+1
9990     STA $0C
10000    LDA INI+2
10010    STA $0D
10020    LDA EXT
10030    CMP #$80
10040    BEQ TDOS
10050    RTS 
10060 TDOS JMP ($0A)
10070 OLDE .WORD 0
10080 OLDBAS .BYTE 0
10090 OLDEB .BYTE 0
10100 OLDGINT .BYTE 0
10110 SWITCH LDA #$00
10120    STA $D40E
10130    STA $D500,X
10140    LDA $D013
10150    STA $03FA
10160    LDA #$40
10170    STA $D40E
10180    RTS 
10190 START
10200    LDA #$00
10210    STA NEW
10220    STA EXT
10230 INIT
10240    BIT NEW
10250    BMI NEST
10260    LDX #$FF
10270    TXS 
10280    LDA $03FA
10290    STA OLDGINT
10300    LDX #$08
10310    JSR SWITCH
10320    LDA $03F8
10330    STA OLDBAS
10340    LDA #1
10350    STA $03F8
10360    LDA $03EB
10370    STA OLDEB
10380    LDX #$FF
10390    STX STAX
10400    LDA $0C
10410    STA INI+1
10420    LDA $0D
10430    STA INI+2
10440    LDA MEMHI
10450    STA OLDE
10460    LDA MEMHI+1
10470    STA OLDE+1
10480    LDA # <RESET
10490    STA $0C
10500    LDA # >RESET
10510    STA $0D
10520    LDA #$FF
10530    STA NEW
10540    JMP $E474
10550 MAIN
10560 NEST BIT EXT
10570    BMI MAINC
10580    JSR GRAPH0
10590    JSR COPY6
10600    JSR DLINIT
10610    JSR KEYOPEN
10620    LDA #$41
10630    STA MAX
10640    JSR NORM
10650    LDA #0
10660    STA 82
10670    STA 85
10680    STA 86
10690    LDA #23
10700    STA 84
10710    LDX # <LTXT
10720    LDY # >LTXT
10730    LDA #LTXTL
10740    JSR PRINT
10750    JSR SETPNT
10760    JSR LOADMENU
10770    LDA #$FF
10780    STA EXT
10790 CLRSCR LDX # <CLR
10800    LDY # >CLR
10810    LDA #1
10820    JSR PRINT
10830    JSR INHDL
10840 MAINC LDA #0
10850    STA 82
10860    STA 85
10870    STA 86
10880    LDA #23
10890    STA 84
10900    JSR PRINTEOL
10910    JSR CLOSEALL
10920    JSR SETOLD
10930    LDX # <ITEM
10940    LDY # >ITEM
10950    LDA #ITEML
10960    JSR PRINT
10970    JSR CURSOFF
10980    JSR EXBLOCK
10990    LDA #$FF
11000    STA 764
11010    JSR EBREAK
11020    JSR NORM
11030 WTAI LDA 764
11040    CMP #$FF
11050    BNE CON
11060    LDA $11
11070    BMI WTAI
11080 CON
11090    JSR INHDL
11100    JSR COPY6
11110 ERS JSR GKEY
11120    PHA 
11130    LDX # <PRX
11140    LDY # >PRX
11150    LDA #2
11160    JSR PRINT
11170    PLA 
11180    AND #$5F
11190    CMP #$0F    ; '/
11200    BEQ EXTENDED
11210    CMP #$1B    ; EOL
11220    BEQ CLRSCR
11230    CMP MAX
11240    BCS WTAI
11250    SEC 
11260    SBC #'A
11270    BCC WTAI
11280    ASL A
11290    PHA 
11300    JSR COPY6
11310    CLD 
11320    PLA 
11330    TAX 
11340    JSR TORUN
11350    JMP MAINC
11360 ITEM .BYTE 155,"Select item or “≈‘’“Œ to clear",155
11370 ITEML = *-ITEM
11380 PRX .BYTE "ú"
11390 CLR .BYTE "}"
11400 LTXT .BYTE 155,155,"Loading menufunctions, please wait..."
11410 LTXTL = *-LTXT
11420 EXTENDED
11430    LDX # <EXTT
11440    LDY # >EXTT
11450    LDA #EXTTL
11460    JSR PRINT
11470    JSR CURSON
11480    JSR SETBUF1
11490    JSR INPUT
11500    JSR CURSOFF
11510    LDX #$20
11520    JSR SETIOCB
11530    JSR CLOSE
11540    JSR SETBUF1
11550    JSR ADDD
11560    JSR SETBUF1
11570    LDA #$04
11580    JSR OPEN
11590    JSR SUBERROR
11600    LDA #$00
11610    STA EXT
11620    JSR SETPNT
11630    JSR DLINIT
11640    JSR RELOAD
11650    JSR PRINTEOL
11660    JMP MAINC
11670 TM JMP MAIN
11680 TOINIT
11690    JMP ($D4)
11700 SETPNT LDA #'A
11710    STA MAX
11720    LDA #$00
11730    STA $C0
11740    LDA # <MENBI
11750    STA $C2
11760    LDA # >MENBI
11770    STA $C3
11780    LDA # <DUPE
11790    STA DUPEND
11800    STA MEMHI
11810    LDA # >DUPE
11820    STA DUPEND+1
11830    STA MEMHI+1
11840    RTS 
11850 TORUN
11860    LDA JMPTAB,X
11870    STA $B2
11880    LDA JMPTAB+1,X
11890    STA $B3
11900    JMP ($B2)
11910 EXTT .BYTE "Enter file to execute :"
11920 EXTTL = *-EXTT
11930 COPY6
11940    LDX #$FF
11950 C6 LDA JUMPTAB,X
11960    STA $0600,X
11970    DEX 
11980    BNE C6
11990    RTS 
12000 MENFIL .BYTE "D:MENULST.SYS",155
12010 LOADMENU
12020    LDX # <LD
12030    LDY # >LD
12040    LDA #15
12050    JSR TOHDL
12060    LDX #$10
12070    JSR SETIOCB
12080    JSR CLOSE
12090    LDX # <MENFIL
12100    LDY # >MENFIL
12110    LDA #4
12120    JSR OPEN
12130    BMI MENERROR
12140 LOADCNT LDX #$10
12150    JSR SETIOCB
12160    JSR SETBUF1
12170    JSR SETBUF
12180    LDX #40
12190    LDY #0
12200    JSR SETLEN
12210    LDA #$05
12220    JSR TOCIO
12230    CPY #136
12240    BEQ LDFIL
12250    CPY #$00
12260    BMI MENERROR
12270    LDX #$20
12280    JSR SETIOCB
12290    JSR CLOSE
12300    JSR SETBUF1
12310    JSR ADDD
12320    JSR SETBUF1
12330    LDA #4
12340    JSR OPEN
12350    BMI MENERROR
12360    JSR RELOAD
12370    CLC 
12380    BCC LOADCNT
12390 LDFIL LDX #$10
12400    LDA #$0C
12410    STA $0342,X
12420    JSR $E456
12430    RTS 
12440 LD .SBYTE "loading menu..."
12450 MENERROR
12460    LDX #$10
12470    JSR SETIOCB
12480    JSR CLOSE
12490    LDX #$20
12500    JSR SETIOCB
12510    JSR CLOSE
12520    JSR KEYOPEN
12530    JSR INHDL
12540    LDX # <ERRM
12550    LDY # >ERRM
12560    LDA #37
12570    JSR TOHDL
12580 SYSIN JSR CLOSEALL
12590    LDA OLDE
12600    STA MEMHI
12610    LDA OLDE+1
12620    STA MEMHI+1
12630    JSR GKEY
12640    CMP #'Q
12650    BEQ QUIT
12660    LDA #$00
12670    STA EXT
12680    JMP $E474
12690 QUIT LDA #$F0
12700    STA NEW
12710    JMP $E474
12720 ERRM .SBYTE "Load error, hit Q to quit,R to retry."
12730 MENERROR1 BMI MENERROR
12740 RELOAD
12750    LDA DUPEND
12760    BEQ OKPG
12770    LDA #$00
12780    STA DUPEND
12790    STA MEMHI
12800    INC DUPEND+1
12810    INC MEMHI+1
12820 OKPG LDX #$20  ; NAECHSTE MOEGLICHE LADEADRESSE
12830    JSR SETIOCB
12840    LDX #2
12850    LDY #$00
12860    JSR SETLEN
12870    LDX #$B2
12880    LDY #$00
12890    JSR BGET
12900    BMI MENERROR1 ; LESE STARTBYTES
12910    LDA $B2
12920    CMP #$9B
12930    BNE MENERROR1
12940    LDA $B3
12950    CMP #$9B
12960    BNE MENERROR1
12970 GETCON LDX #$02 ; SCHLEIFE
12980    LDY #$00
12990    JSR SETLEN
13000    LDX #$B2
13010    LDY #$00
13020    JSR BGET    ; 1.ADRESSE
13030 MENERROR2 BMI MENERROR1
13040    LDA $B2
13050    ORA $B3
13060    BEQ FINTAB  ; ENDE TABELLE
13070    LDA $C0
13080    ASL A
13090    TAX 
13100    LDA $B2
13110    CLC 
13120    ADC DUPEND
13130    STA JMPTAB,X
13140    LDA $B3
13150    ADC DUPEND+1
13160    STA JMPTAB+1,X ; IN TAB EINFUEGEN
13170    LDX # <DL1
13180    LDY # >DL1
13190    JSR TOZERO
13200    LDA $C0
13210    LSR A
13220    TAX 
13230    INX 
13240    JSR DLWAUF  ; MENU VERGROESSERN
13250    LDA MAX
13260    SEC 
13270    SBC #$20
13280    LDY #$00
13290    STA ($C2),Y
13300    INY 
13310    LDA #$0E
13320    STA ($C2),Y
13330    LDX #18
13340    LDY #0
13350    JSR SETLEN
13360    LDA $C2
13370    CLC 
13380    ADC #$02
13390    TAX 
13400    LDY $C3
13410    BCC NH1
13420    INY 
13430 NH1 JSR BGET   ; NAMEN EINFUEGEN
13440    BMI MENERROR2
13450    INC $C0
13460    INC MAX
13470    LDA $C2
13480    CLC 
13490    ADC #20
13500    STA $C2
13510    BCC NH2
13520    INC $C3
13530 NH2 CLC 
13540    JMP GETCON
13550 FINTAB LDX #$D4
13560    LDY #$00
13570    JSR BGET    ; HOLE INIT-ADR
13580 MENERROR3 BMI MENERROR2
13590    LDX #$B2
13600    LDY #$00
13610    JSR BGET    ; HOLE LAENGE
13620    BMI MENERROR3
13630    LDX $B2
13640    LDY $B3
13650    JSR SETLEN  ; BYTES RESERVIEREN
13660    LDX $B2
13670    LDY $B3
13680    JSR RESERVE
13690    JSR BGET    ; AB ADR. EINLESEN
13700    LDA DUPEND
13710    STA $B2
13720    LDA DUPEND+1
13730    STA $B3     ; ALTE START-ADR.
13740    LDA #$01
13750    STA $B4
13760    LDX #$00
13770    LDY #$00
13780    JSR SETLEN
13790 BGEL
13800    LSR $B4
13810    BCC NNV
13820    JSR BGET
13830    CPY #136
13840    BEQ FINLO
13850    CPY #$00
13860    BMI MENERROR3
13870    STA $B5
13880    LDA #$80
13890    STA $B4
13900 NNV LDA $B5
13910    AND $B4
13920    BEQ NORELO
13930    LDY #$00
13940    LDA ($B2),Y
13950    CLC 
13960    ADC DUPEND+1
13970    STA ($B2),Y
13980 NORELO INC $B2
13990    BNE BGEL
14000    INC $B3
14010    BNE BGEL
14020 FINLO JSR CLOSE
14030    LDA $D4
14040    CLC 
14050    ADC DUPEND
14060    STA $D4
14070    LDA $D5
14080    ADC DUPEND+1
14090    STA $D5
14100    LDA MEMHI
14110    STA DUPEND
14120    LDA MEMHI+1
14130    STA DUPEND+1
14140    JSR COPY6
14150    JSR TOINIT
14160    RTS 
14170 CLOSEALL
14180    LDX #$10
14190    STX IOCB
14200 NLA JSR CLOSE
14210    LDA IOCB
14220    CLC 
14230    ADC #$10
14240    STA IOCB
14250    LDA IOCB
14260    CMP #$70
14270    BCC NLA
14280    RTS 
14290 GETLIST STX $B8
14300    STY $B9
14310    LDA #$00
14320    STA $BA
14330    LDX #$10
14340    JSR SETIOCB
14350    JSR CLOSE
14360    LDX $B8
14370    LDY $B9
14380    JSR ADDD
14390    LDY #$00
14400    LDA ($B8),Y
14410    CMP #'D
14420    BNE INSAL
14430    LDX $B8
14440    LDY $B9
14450    LDA #$07
14460    JSR OPEN    ; OPEN FOR DIR
14470    JSR SUBERROR
14480    LDX #$00
14490    LDY #$00
14500    JSR RESERVE ; $00 BYTES RESERVIEREN
14510    STX $D4
14520    STY $D5
14530 LP LDX #40
14540    LDY #0
14550    JSR SETLEN
14560    JSR SETINPBF
14570    JSR SETBUF
14580    LDA #5
14590    JSR TOCIO
14600    JSR SUBERROR
14610    LDX #$20
14620    LDY #$00
14630    JSR RESERVE
14640    STX $B8
14650    STY $B9
14660    LDY #$00
14670    LDA #0
14680    STA ($B8),Y
14690    LDA INPBF+1
14700    CMP #32
14710    BNE EOFDIR
14720    INC $BA
14730    JSR SETINPBF
14740    JSR CONFILE
14750    LDY #$01
14760 LS LDA BUF3-1,Y
14770    STA ($B8),Y
14780    INY 
14790    CMP #$9B
14800    BNE LS
14810    BEQ LP
14820 EOFDIR
14830    LDA #$9B
14840    LDY #$01
14850    STA ($B8),Y
14860    LDA $BA
14870    BEQ ERA0
14880    LDX $D4
14890    LDY $D5
14900    RTS 
14910 ERA0 LDY #$AA
14920    JMP ERROR
14930 INSAL ;        KEINE DISKETTE,ALSO DIREKT ZUM BUFFER
14940    LDX #$40
14950    LDY #$00
14960    JSR RESERVE
14970    STX $D4
14980    STY $D5
14990    LDY #$00
15000    TYA 
15010    STA ($D4),Y
15020    LDY #$20
15030    STA ($D4),Y
15040    INY 
15050    LDA #$9B
15060    STA ($D4),Y
15070    LDY #$00
15080 SONE LDA ($B8),Y
15090    INY 
15100    STA ($D4),Y
15110    CMP #$9B
15120    BNE SONE
15130    LDX $D4
15140    LDY $D5
15150    RTS 
15160 GETENTRY JSR TOZERO
15170    STA $B4
15180    LDX #$03
15190 LSC LDA DEFLEN,X
15200    STA $E0,X
15210    DEX 
15220    BPL LSC
15230    LDA $B4
15240    JSR SETDEFAUL
15250 GTE LDY #$00
15260    LDA ($B2),Y
15270    BPL NOTUSED
15280    LDA $B2
15290    CLC 
15300    ADC #$20
15310    STA $B2
15320    BCC GTE
15330    INC $B3
15340    BNE GTE
15350 NOTUSED LDA $B2
15360    STA $D6
15370    LDA $B3
15380    STA $D7
15390    INY 
15400    LDA ($B2),Y
15410    CMP #$9B
15420    BEQ ENDE
15430    JSR SETINPBF
15440    STX $D4
15450    STY $D5
15460    LDX $B2
15470    LDY $B3
15480    INX 
15490    BNE INC2
15500    INY 
15510 INC2 LDA #40
15520    JSR COPY    ; EINTRAG -> INPBF
15530    JSR SETINPBF
15540    JSR ADDD    ; DEVICE # ADDIEREN
15550    CLC 
15560    BCC COPYB
15570 ENDE
15580    SEC 
15590 COPYB PHP 
15600    LDX #3
15610 CPBL LDA $E0,X
15620    STA DEFLEN,X
15630    DEX 
15640    BPL CPBL
15650    PLP 
15660    LDX $D6
15670    LDY $D7
15680    RTS 
15690 GETDEVNO ;     (X,Y)->A
15700    STX $B8
15710    STY $B9
15720    JSR ADDD    ; IM ZWEIFELSFALL ADDIEREN
15730    LDY #$01
15740    LDA ($B8),Y
15750    CMP #':
15760    BEQ ONE
15770    RTS 
15780 ONE LDA #'1
15790    RTS 
15800 SETDEFAUL
15810    STA DEFAULT+1
15820    LDA #3
15830    STA DEFLEN
15840    LDA #'D
15850    STA DEFAULT
15860    LDA #':
15870    STA DEFAULT+2
15880    RTS 
15890    .BYTE 0
15900 DUPE .BYTE 0
